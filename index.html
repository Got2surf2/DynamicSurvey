<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Survey with Ana</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --bg-color: #f7fafc;
            --chat-bg: #ffffff;
            --user-bubble: #667eea;
            --ana-bubble: #f7fafc;
            --text-dark: #2d3748;
            --text-light: #718096;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--bg-color);
            background-image: var(--background-image, none);
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .chat-container {
            background: var(--chat-bg);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
            max-width: 600px;
            width: 100%;
            height: 90vh;
            max-height: 800px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .logo-container {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .logo {
            max-width: 100%;
            max-height: 100%;
            display: none;
        }

        .logo.visible {
            display: block;
        }

        .avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            color: var(--primary-color);
        }

        .header-info {
            flex: 1;
        }

        .header-info h2 {
            color: white;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .header-info p {
            color: rgba(255, 255, 255, 0.9);
            font-size: 13px;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            padding-bottom: 80px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            display: flex;
            gap: 10px;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            flex-shrink: 0;
        }

        .message.user .message-avatar {
            background: var(--user-bubble);
        }

        .message-content {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            line-height: 1.5;
            font-size: 15px;
        }

        .message.ana .message-content {
            background: var(--ana-bubble);
            color: var(--text-dark);
            border-bottom-left-radius: 4px;
        }

        .message.user .message-content {
            background: var(--user-bubble);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .typing-indicator {
            display: flex;
            gap: 10px;
            padding: 0 20px;
            margin-bottom: 15px;
            display: none;
        }

        .typing-indicator.active {
            display: flex;
            animation: slideIn 0.3s ease-out;
        }

        .typing-indicator .message-avatar {
            width: 36px;
            height: 36px;
        }

        .typing-dots {
            background: var(--ana-bubble);
            padding: 12px 16px;
            border-radius: 18px;
            border-bottom-left-radius: 4px;
            display: flex;
            gap: 4px;
            align-items: center;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-light);
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.7;
            }
            30% {
                transform: translateY(-10px);
                opacity: 1;
            }
        }

        .chat-input-area {
            padding: 20px;
            background: white;
            border-top: 1px solid #e2e8f0;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .nps-scale {
            display: grid;
            grid-template-columns: repeat(11, 1fr);
            gap: 6px;
        }

        .nps-button {
            aspect-ratio: 1;
            border: 2px solid #e2e8f0;
            background: white;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            color: var(--text-dark);
        }

        .nps-button:hover {
            border-color: var(--primary-color);
            transform: scale(1.05);
        }

        .nps-button.selected {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .nps-labels {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: var(--text-light);
            margin-top: 4px;
        }

        textarea {
            width: 100%;
            min-height: 80px;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 15px;
            font-family: inherit;
            resize: vertical;
            transition: border-color 0.2s ease;
        }

        textarea:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        input[type="text"],
        input[type="email"],
        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 15px;
            font-family: inherit;
            transition: border-color 0.2s ease;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .radio-option {
            display: flex;
            align-items: center;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .radio-option:hover {
            border-color: var(--primary-color);
            background: rgba(102, 126, 234, 0.05);
        }

        .radio-option input[type="radio"] {
            margin-right: 10px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .radio-option label {
            cursor: pointer;
            font-size: 14px;
            color: var(--text-dark);
            flex: 1;
        }

        .send-button {
            width: 100%;
            padding: 14px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .send-button:hover:not(:disabled) {
            background: var(--secondary-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .demographic-grid {
            display: grid;
            gap: 10px;
        }

        .completion-content {
            text-align: center;
            padding: 40px 20px;
        }

        .completion-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .completion-content h3 {
            color: var(--text-dark);
            font-size: 22px;
            margin-bottom: 10px;
        }

        .completion-content p {
            color: var(--text-light);
            font-size: 15px;
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .download-button {
            background: #48bb78;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            margin: 5px;
        }

        .download-button:hover {
            background: #38a169;
        }

        @media (max-width: 600px) {
            .nps-scale {
                grid-template-columns: repeat(6, 1fr);
            }

            .chat-container {
                height: 100vh;
                border-radius: 0;
            }
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <div class="logo-container" id="logoContainer">
                <img src="" alt="Logo" class="logo" id="surveyLogo">
                <div class="avatar" id="defaultAvatar">A</div>
            </div>
            <div class="header-info">
                <h2>Ana</h2>
                <p>Feedback Specialist</p>
            </div>
        </div>

        <div class="chat-messages" id="chatMessages"></div>

        <div class="typing-indicator" id="typingIndicator">
            <div class="message-avatar">A</div>
            <div class="typing-dots">
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            </div>
        </div>

        <div class="chat-input-area" id="inputArea"></div>
    </div>

    <script>
        // ============================================
        // CONFIGURATION - EDIT THESE VALUES
        // ============================================
        
        const CONFIG = {
            // NPS Question
            npsQuestion: "On a scale of 0 to 10, how likely are you to recommend our product/service to a friend or colleague?",
            
            // Number of open-ended questions
            numOpenEndedQuestions: 3,
            
            // Follow-up questions by NPS category
            detractorQuestions: [
                "I'm sorry to hear that. What was the main issue you experienced?",
                "What specific changes would make things better for you?",
                "Was there a particular moment that led to your rating?"
            ],
            passiveQuestions: [
                "Thanks for your feedback! What would make your experience even better?",
                "What's one thing we do well and one thing we could improve?",
                "What would it take to make you more enthusiastic about recommending us?"
            ],
            promoterQuestions: [
                "That's wonderful to hear! What do you love most about your experience?",
                "What would you tell a friend who asked about us?",
                "How have we exceeded your expectations?"
            ],
            
            // Branding
            logoUrl: "", // Add your logo URL here
            primaryColor: "#667eea",
            secondaryColor: "#764ba2",
            backgroundImage: "", // Add background image URL here
            
            // Intro message
            introMessage: "Hey there! ðŸ‘‹ I'm Ana, and I'd love to get your quick feedback. This will only take a couple of minutes, and your thoughts will really help us improve. Ready to get started?"
        };
        
        // ============================================
        // END CONFIGURATION
        // ============================================

        // Apply custom styling
        if (CONFIG.primaryColor) {
            document.documentElement.style.setProperty('--primary-color', CONFIG.primaryColor);
        }
        if (CONFIG.secondaryColor) {
            document.documentElement.style.setProperty('--secondary-color', CONFIG.secondaryColor);
        }
        if (CONFIG.backgroundImage) {
            document.documentElement.style.setProperty('--background-image', `url(${CONFIG.backgroundImage})`);
        }
        if (CONFIG.logoUrl) {
            document.getElementById('surveyLogo').src = CONFIG.logoUrl;
            document.getElementById('surveyLogo').classList.add('visible');
            document.getElementById('defaultAvatar').style.display = 'none';
        }

        // Survey State
        const surveyData = {
            npsScore: null,
            npsCategory: null,
            responses: {},
            demographics: {},
            psychographics: {},
            timestamp: new Date().toISOString()
        };

        let currentStep = 0;
        let clarificationAsked = {};
        let currentQuestionId = null;

        // Psychographic Questions Bank
        const psychographicQuestions = [
            {
                id: 'lifestyle',
                question: 'Which best describes your lifestyle?',
                options: [
                    'Adventure-seeker and spontaneous',
                    'Organized and routine-oriented',
                    'Social and community-focused',
                    'Independent and self-directed',
                    'Family-centered and traditional'
                ]
            },
            {
                id: 'values',
                question: 'What do you value most when making decisions?',
                options: [
                    'Quality and durability',
                    'Price and affordability',
                    'Innovation and latest features',
                    'Sustainability and ethics',
                    'Brand reputation'
                ]
            },
            {
                id: 'decision_style',
                question: 'How would you describe your decision-making style?',
                options: [
                    'Analytical - I research thoroughly',
                    'Intuitive - I trust my gut',
                    'Consultative - I seek opinions',
                    'Impulsive - I decide quickly',
                    'Pragmatic - I focus on outcomes'
                ]
            },
            {
                id: 'innovation',
                question: 'When it comes to new products or trends:',
                options: [
                    'I\'m among the first to try them',
                    'I wait for validation first',
                    'I adopt when they\'re mainstream',
                    'I rarely change from what I know',
                    'I only adopt if necessary'
                ]
            },
            {
                id: 'communication',
                question: 'How do you prefer to receive information?',
                options: [
                    'Detailed written content',
                    'Visual content like videos',
                    'Personal recommendations',
                    'Expert reviews and ratings',
                    'Hands-on trial and experience'
                ]
            },
            {
                id: 'risk_tolerance',
                question: 'When trying something new:',
                options: [
                    'Very comfortable with risk',
                    'Somewhat comfortable if benefit is high',
                    'Neutral - depends on situation',
                    'Cautious and prefer proven options',
                    'Very risk-averse'
                ]
            },
            {
                id: 'time_perspective',
                question: 'Which describes your approach to goals?',
                options: [
                    'Focus on long-term planning',
                    'Balance short and long-term',
                    'Focus on immediate results',
                    'Adapt based on circumstances',
                    'Rarely set specific goals'
                ]
            },
            {
                id: 'social_influence',
                question: 'How much do others\' opinions influence you?',
                options: [
                    'Very much - I value social proof',
                    'Somewhat - I consider them',
                    'Minimally - I prefer my own opinions',
                    'Not at all - I ignore influence',
                    'It varies by decision'
                ]
            }
        ];

        // Select 3 random psychographic questions
        const selectedPsychographicQuestions = psychographicQuestions
            .sort(() => 0.5 - Math.random())
            .slice(0, 3);

        // Get appropriate follow-up questions based on NPS category
        function getFollowUpQuestions() {
            const category = surveyData.npsCategory;
            if (category === 'detractor') return CONFIG.detractorQuestions;
            if (category === 'passive') return CONFIG.passiveQuestions;
            return CONFIG.promoterQuestions;
        }

        // Add message to chat
        function addMessage(text, sender = 'ana') {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = sender === 'ana' ? 'A' : 'Y';
            
            const content = document.createElement('div');
            content.className = 'message-content';
            content.textContent = text;
            
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(content);
            messagesContainer.appendChild(messageDiv);
            
            // Scroll to show the new message above the input area
            setTimeout(() => {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }, 50);
        }

        // Show typing indicator
        function showTyping() {
            document.getElementById('typingIndicator').classList.add('active');
            const messagesContainer = document.getElementById('chatMessages');
            setTimeout(() => {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }, 50);
        }

        // Hide typing indicator
        function hideTyping() {
            document.getElementById('typingIndicator').classList.remove('active');
        }

        // Simulate Ana typing and then showing message
        function anaTyping(message, callback) {
            showTyping();
            const typingDelay = Math.min(1500, message.length * 20 + 500);
            setTimeout(() => {
                hideTyping();
                addMessage(message, 'ana');
                if (callback) {
                    setTimeout(callback, 300);
                }
            }, typingDelay);
        }

        // Extract key topics from response
        function extractKeyTopics(response) {
            const words = response.toLowerCase().split(/\s+/);
            const stopWords = new Set(['the', 'a', 'an', 'and', 'or', 'but', 'in', 'on', 'at', 'to', 'for', 'of', 'with', 'by', 'from', 'up', 'about', 'into', 'through', 'is', 'was', 'were', 'my', 'your', 'our', 'their', 'it', 'its', 'this', 'that']);
            
            return words.filter(word => 
                word.length > 3 && 
                !stopWords.has(word) && 
                !/^\d+$/.test(word)
            ).slice(0, 3);
        }

        // Check if needs clarification - only if genuinely ambiguous
        function needsClarification(response) {
            const words = response.split(/\s+/).length;
            
            // Don't ask for clarification if response has concrete, specific details
            const hasConcreteDetails = /\b(too|very|extremely|really|quite|because|since|when|where|who|which|how|why)\b/i.test(response);
            const hasSpecificDescriptors = /\b(thick|thin|cold|hot|slow|fast|expensive|cheap|broken|missing|late|early|small|large|difficult|easy|long|short)\b/i.test(response);
            const hasNumbers = /\d+/.test(response);
            const hasClearComparison = /\b(more|less|better|worse|bigger|smaller|than|most|least)\b/i.test(response);
            const hasTimeContext = /\b(always|never|often|sometimes|usually|rarely|today|yesterday|last|first|then)\b/i.test(response);
            
            // If response has ANY concrete details, it's specific enough - don't ask for clarification
            if (hasConcreteDetails || hasSpecificDescriptors || hasNumbers || hasClearComparison || hasTimeContext) {
                return false;
            }
            
            // Only ask for clarification if truly vague and lacking detail
            const hasVagueTerms = /\b(good|bad|okay|fine|nice|thing|stuff|something|kind of|sort of)\b/i.test(response);
            const isVeryShort = words < 5;
            const lacksAnySpecifics = !(/\b(because|specifically|example|such as|like|for instance)\b/i.test(response));
            
            // Need clarification ONLY if: very short OR (vague terms AND no specifics)
            return isVeryShort || (hasVagueTerms && lacksAnySpecifics && words < 10);
        }

        // Generate contextual clarification question based on user's response
        function generateClarification(response) {
            const responseLower = response.toLowerCase();
            const words = response.split(/\s+/).length;
            
            // For vague positive terms without context
            if (/\b(good|great|nice)\b/i.test(response) && words < 6) {
                return `Glad to hear that! What specifically made it good?`;
            } 
            // For vague negative terms without context
            else if (/\b(bad|poor)\b/i.test(response) && words < 6) {
                return `I hear you. What made it disappointing?`;
            } 
            // For "thing" or "stuff" - truly vague
            else if (/\b(thing|stuff)\b/i.test(response)) {
                return `Got it! Can you be more specific about what you mean?`;
            } 
            // For very short responses (under 5 words)
            else if (words < 5) {
                return `Thanks! Could you tell me a bit more about that?`;
            } 
            // Default - ask for more detail
            else {
                return `Interesting! Can you give me more details?`;
            }
        }

        // Render ready choice
        function renderReadyChoice() {
            const inputArea = document.getElementById('inputArea');
            const html = `
                <div class="input-group">
                    <div class="radio-group">
                        <div class="radio-option" onclick="selectReady(true)">
                            <input type="radio" name="ready" id="ready-yes" value="yes">
                            <label for="ready-yes">Yep, I'm ready!</label>
                        </div>
                        <div class="radio-option" onclick="selectReady(false)">
                            <input type="radio" name="ready" id="ready-no" value="no">
                            <label for="ready-no">Not right now</label>
                        </div>
                    </div>
                    <button class="send-button" id="readySubmit" disabled onclick="submitReady()">Continue</button>
                </div>
            `;
            inputArea.innerHTML = html;
            
            // Scroll to show Ana's question above the input
            setTimeout(() => {
                document.getElementById('chatMessages').scrollTop = document.getElementById('chatMessages').scrollHeight;
            }, 100);
        }

        let isReady = null;

        // Select ready option
        function selectReady(ready) {
            isReady = ready;
            document.querySelectorAll('input[name="ready"]').forEach(input => {
                input.checked = input.value === (ready ? 'yes' : 'no');
            });
            document.getElementById('readySubmit').disabled = false;
        }

        // Submit ready choice
        function submitReady() {
            const choice = isReady ? "Yep, I'm ready!" : "Not right now";
            addMessage(choice, 'user');
            document.getElementById('inputArea').innerHTML = '';
            
            if (!isReady) {
                // User declined
                setTimeout(() => {
                    anaTyping("No worries at all! Thanks for your time, and feel free to come back whenever you're ready. Have a great day! ðŸ‘‹", () => {
                        document.getElementById('inputArea').innerHTML = '';
                    });
                }, 500);
                return;
            }
            
            // User is ready - continue with survey
            setTimeout(() => {
                anaTyping(CONFIG.npsQuestion, () => {
                    renderNPSInput();
                });
            }, 500);
        }
        function renderNPSInput() {
            const inputArea = document.getElementById('inputArea');
            let html = '<div class="input-group">';
            html += '<div class="nps-scale">';
            for (let i = 0; i <= 10; i++) {
                html += `<button class="nps-button" onclick="selectNPS(${i})">${i}</button>`;
            }
            html += '</div>';
            html += '<div class="nps-labels"><span>Not likely</span><span>Very likely</span></div>';
            html += '<button class="send-button" id="npsSubmit" disabled onclick="submitNPS()">Send</button>';
            html += '</div>';
            inputArea.innerHTML = html;
            
            // Scroll to show Ana's question above the input
            setTimeout(() => {
                document.getElementById('chatMessages').scrollTop = document.getElementById('chatMessages').scrollHeight;
            }, 100);
        }

        // Select NPS score
        function selectNPS(score) {
            surveyData.npsScore = score;
            
            if (score <= 6) {
                surveyData.npsCategory = 'detractor';
            } else if (score <= 8) {
                surveyData.npsCategory = 'passive';
            } else {
                surveyData.npsCategory = 'promoter';
            }

            document.querySelectorAll('.nps-button').forEach((btn, index) => {
                btn.classList.toggle('selected', index === score);
            });
            
            document.getElementById('npsSubmit').disabled = false;
        }

        // Submit NPS
        function submitNPS() {
            addMessage(surveyData.npsScore.toString(), 'user');
            document.getElementById('inputArea').innerHTML = '';
            
            setTimeout(() => {
                currentStep++;
                showNextQuestion();
            }, 500);
        }

        // Render text input
        function renderTextInput(placeholder = "Type your response...") {
            const inputArea = document.getElementById('inputArea');
            const html = `
                <div class="input-group">
                    <textarea id="responseText" placeholder="${placeholder}"></textarea>
                    <button class="send-button" onclick="submitTextResponse()">Send</button>
                </div>
            `;
            inputArea.innerHTML = html;
            document.getElementById('responseText').focus();
            
            // Scroll to show Ana's question above the input
            setTimeout(() => {
                document.getElementById('chatMessages').scrollTop = document.getElementById('chatMessages').scrollHeight;
            }, 100);
        }

        // Submit text response
        function submitTextResponse() {
            const textarea = document.getElementById('responseText');
            const response = textarea.value.trim();
            
            if (!response) {
                alert('Please provide a response.');
                return;
            }

            addMessage(response, 'user');
            document.getElementById('inputArea').innerHTML = '';

            // Store response
            if (!surveyData.responses[currentQuestionId]) {
                surveyData.responses[currentQuestionId] = {
                    initial: response,
                    clarification: null
                };
            } else {
                surveyData.responses[currentQuestionId].clarification = response;
            }

            // Check if clarification needed (only once per question)
            if (!clarificationAsked[currentQuestionId] && needsClarification(response)) {
                clarificationAsked[currentQuestionId] = true;
                const clarificationQ = generateClarification(response);
                
                setTimeout(() => {
                    anaTyping(clarificationQ, () => {
                        renderTextInput();
                    });
                }, 500);
                return;
            }

            // Move to next question
            setTimeout(() => {
                currentStep++;
                showNextQuestion();
            }, 500);
        }

        // Render radio input
        function renderRadioInput(options, psychoId) {
            const inputArea = document.getElementById('inputArea');
            let html = '<div class="input-group"><div class="radio-group">';
            
            options.forEach((opt, index) => {
                html += `
                    <div class="radio-option">
                        <input type="radio" name="psycho" id="opt${index}" value="${opt}" onchange="enablePsychoSubmit()">
                        <label for="opt${index}">${opt}</label>
                    </div>
                `;
            });
            
            html += '</div>';
            html += `<button class="send-button" id="psychoSubmit" disabled onclick="submitPsychoResponse('${psychoId}')">Send</button>`;
            html += '</div>';
            inputArea.innerHTML = html;
            
            // Scroll to show Ana's question above the input
            setTimeout(() => {
                document.getElementById('chatMessages').scrollTop = document.getElementById('chatMessages').scrollHeight;
            }, 100);
        }

        // Enable psycho submit
        function enablePsychoSubmit() {
            document.getElementById('psychoSubmit').disabled = false;
        }

        // Submit psychographic response
        function submitPsychoResponse(psychoId) {
            const selected = document.querySelector('input[name="psycho"]:checked');
            if (!selected) return;

            surveyData.psychographics[psychoId] = selected.value;
            addMessage(selected.value, 'user');
            document.getElementById('inputArea').innerHTML = '';

            setTimeout(() => {
                currentStep++;
                showNextQuestion();
            }, 500);
        }

        // Render demographics
        function renderDemographics() {
            const inputArea = document.getElementById('inputArea');
            const html = `
                <div class="input-group">
                    <div class="demographic-grid">
                        <select id="ageRange">
                            <option value="">Age Range</option>
                            <option value="18-24">18-24</option>
                            <option value="25-34">25-34</option>
                            <option value="35-44">35-44</option>
                            <option value="45-54">45-54</option>
                            <option value="55-64">55-64</option>
                            <option value="65+">65+</option>
                        </select>
                        <select id="gender">
                            <option value="">Gender</option>
                            <option value="male">Male</option>
                            <option value="female">Female</option>
                            <option value="non-binary">Non-binary</option>
                            <option value="other">Other</option>
                            <option value="prefer-not">Prefer not to say</option>
                        </select>
                        <input type="text" id="location" placeholder="City, State/Country">
                        <input type="email" id="email" placeholder="Email (optional)">
                    </div>
                    <button class="send-button" onclick="submitDemographics()">Complete Survey</button>
                </div>
            `;
            inputArea.innerHTML = html;
            
            // Scroll to show Ana's question above the input
            setTimeout(() => {
                document.getElementById('chatMessages').scrollTop = document.getElementById('chatMessages').scrollHeight;
            }, 100);
        }

        // Submit demographics
        function submitDemographics() {
            const ageRange = document.getElementById('ageRange').value;
            const gender = document.getElementById('gender').value;
            const location = document.getElementById('location').value;
            const email = document.getElementById('email').value;

            if (!ageRange || !gender) {
                alert('Please select your age range and gender.');
                return;
            }

            surveyData.demographics = { ageRange, gender, location, email };
            
            addMessage(`${ageRange}, ${gender}${location ? ', ' + location : ''}`, 'user');
            document.getElementById('inputArea').innerHTML = '';

            setTimeout(() => {
                showCompletion();
            }, 500);
        }

        // Show completion
        function showCompletion() {
            anaTyping("That's it! Thanks so much for your time and honest feedback. Your insights are incredibly valuable to us! ðŸ™Œ", () => {
                // Survey complete - just clear input area
                document.getElementById('inputArea').innerHTML = '';
            });

            // Log data to console for debugging/testing
            console.log('Survey Data:', surveyData);
            
            // Store in localStorage as backup
            localStorage.setItem('lastSurveyResponse', JSON.stringify(surveyData));
        }

        // Show next question
        function showNextQuestion() {
            const followUpQuestions = getFollowUpQuestions();
            const numFollowUp = Math.min(CONFIG.numOpenEndedQuestions, followUpQuestions.length);
            const totalOpenEnded = numFollowUp;
            const totalPsycho = 3;
            
            // Open-ended questions
            if (currentStep >= 1 && currentStep <= totalOpenEnded) {
                const questionIndex = currentStep - 1;
                currentQuestionId = `openended-${questionIndex}`;
                clarificationAsked[currentQuestionId] = clarificationAsked[currentQuestionId] || false;
                
                anaTyping(followUpQuestions[questionIndex], () => {
                    renderTextInput();
                });
            }
            // Psychographic questions
            else if (currentStep > totalOpenEnded && currentStep <= totalOpenEnded + totalPsycho) {
                const psychoIndex = currentStep - totalOpenEnded - 1;
                const psychoQ = selectedPsychographicQuestions[psychoIndex];
                
                anaTyping(psychoQ.question, () => {
                    renderRadioInput(psychoQ.options, psychoQ.id);
                });
            }
            // Demographics
            else if (currentStep === totalOpenEnded + totalPsycho + 1) {
                anaTyping("Last thing! Just need a few quick details to help us understand our audience better.", () => {
                    renderDemographics();
                });
            }
        }

        // Initialize survey
        function initSurvey() {
            // Show intro
            setTimeout(() => {
                anaTyping(CONFIG.introMessage, () => {
                    setTimeout(() => {
                        renderReadyChoice();
                    }, 300);
                });
            }, 500);
        }

        // Start survey
        initSurvey();
    </script>
</body>
</html>
